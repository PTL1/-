<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library ‚Ä¢ ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f6f8fb}
    .card{border:0;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .badge-status{font-size:.8rem}
    .pointer{cursor:pointer}
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
    <h1 class="h4 m-0">üìö ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
    <div class="d-flex gap-2">
      <input id="adminKey" type="password" class="form-control form-control-sm" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" style="max-width:180px">
      <button class="btn btn-sm btn-primary" onclick="toggleAdmin()">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    </div>
  </div>

  <!-- Search/Filter -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-6"><input id="q" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠/‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á/‡∏´‡∏°‡∏ß‡∏î..." oninput="render()"></div>
        <div class="col-md-3">
          <select id="filterCat" class="form-select" onchange="render()">
            <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‚Äî</option>
          </select>
        </div>
        <div class="col-md-3 text-md-end">
          <button class="btn btn-outline-secondary" onclick="refresh()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="card mb-3 d-none">
    <div class="card-body">
      <h5 class="mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h5>
      <form onsubmit="return saveBook(event)">
        <input type="hidden" id="bookId">
        <div class="row g-2">
          <div class="col-md-4"><input id="title" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" required></div>
          <div class="col-md-3"><input id="author" class="form-control" placeholder="‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á"></div>
          <div class="col-md-3"><input id="category" class="form-control" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"></div>
          <div class="col-12"><textarea id="description" class="form-control" rows="2" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea></div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button class="btn btn-secondary" type="button" onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          <button id="btnDelete" class="btn btn-danger d-none" type="button" onclick="deleteBook()">‡∏•‡∏ö</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="statTotal">0</span> | ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°: <span id="statBorrowed">0</span></div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th>‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á</th>
              <th>‡∏´‡∏°‡∏ß‡∏î</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="text-end">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
let adminMode = false;
let books = [];

function toggleAdmin(){
  adminMode = !adminMode;
  document.getElementById('adminPanel').classList.toggle('d-none', !adminMode);
  document.getElementById('btnDelete').classList.toggle('d-none', !adminMode);
}

async function refresh(){
  const res = await fetch('/api/books');
  books = await res.json();
  fillCategories();
  render();
}

function fillCategories(){
  const sel = document.getElementById('filterCat');
  const current = sel.value;
  const cats = Array.from(new Set(books.map(b => (b.category||'').trim()).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‚Äî</option>' + cats.map(c=>`<option ${c===current?'selected':''}>${escapeHtml(c)}</option>`).join('');
}

function render(){
  const q = (document.getElementById('q').value||'').toLowerCase();
  const cat = (document.getElementById('filterCat').value||'').toLowerCase();
  const filtered = books.filter(b=>{
    const hitQ = !q || (b.title||'').toLowerCase().includes(q) || (b.author||'').toLowerCase().includes(q) || (b.category||'').toLowerCase().includes(q);
    const hitC = !cat || (b.category||'').toLowerCase() === cat;
    return hitQ && hitC;
  });

  const tb = document.getElementById('rows'); tb.innerHTML='';
  filtered.forEach(b=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${b.id}</td>
      <td class="pointer" onclick="edit(${b.id})">${escapeHtml(b.title||'')}</td>
      <td>${escapeHtml(b.author||'')}</td>
      <td>${escapeHtml(b.category||'')}</td>
      <td>${b.is_borrowed ? '<span class="badge text-bg-danger badge-status">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</span>' : '<span class="badge text-bg-success badge-status">‡∏ß‡πà‡∏≤‡∏á</span>'}</td>
      <td class="text-end">
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary" onclick="edit(${b.id})">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          <button class="btn btn-sm btn-outline-success" ${b.is_borrowed?'disabled':''} onclick="borrow(${b.id})">‡∏¢‡∏∑‡∏°</button>
          <button class="btn btn-sm btn-outline-warning" ${b.is_borrowed?'':'disabled'} onclick="ret(${b.id})">‡∏Ñ‡∏∑‡∏ô</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });

  // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
  document.getElementById('statTotal').textContent = books.length;
  document.getElementById('statBorrowed').textContent = books.filter(b=>b.is_borrowed).length;
}

function edit(id){
  const b = books.find(x=>x.id===id);
  if(!b) return;
  document.getElementById('bookId').value = b.id;
  document.getElementById('title').value = b.title||'';
  document.getElementById('author').value = b.author||'';
  document.getElementById('category').value = b.category||'';
  document.getElementById('description').value = b.description||'';
  if (adminMode) document.getElementById('adminPanel').classList.remove('d-none');
  window.scrollTo({top:0,behavior:'smooth'});
}

async function saveBook(e){
  e.preventDefault();
  const adminKey = document.getElementById('adminKey').value;
  if(!adminKey) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');

  const payload = {
    title: document.getElementById('title').value,
    author: document.getElementById('author').value,
    category: document.getElementById('category').value,
    description: document.getElementById('description').value
  };

  const id = Number(document.getElementById('bookId').value||0);
  let res;
  if(id){
    // ‡πÉ‡∏ä‡πâ PUT /api/books/:id
    res = await fetch('/api/books/'+id, { method:'PUT', headers:{'Content-Type':'application/json','x-admin-key':adminKey}, body:JSON.stringify(payload) });
  }else{
    res = await fetch('/api/books', { method:'POST', headers:{'Content-Type':'application/json','x-admin-key':adminKey}, body:JSON.stringify(payload) });
  }
  const out = await res.json();
  if(!res.ok) return alert(out.error||'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  resetForm(); await refresh();
}

async function deleteBook(){
  const adminKey = document.getElementById('adminKey').value;
  const id = Number(document.getElementById('bookId').value||0);
  if(!id) return;
  if(!confirm('‡∏•‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏µ‡πâ?')) return;
  const res = await fetch('/api/books/'+id, { method:'DELETE', headers:{'x-admin-key':adminKey} });
  const out = await res.json();
  if(!res.ok) return alert(out.error||'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  resetForm(); await refresh();
}

async function borrow(id){
  const adminKey = document.getElementById('adminKey').value;
  if(!adminKey) return alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  const borrower = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°:'); if(!borrower) return;
  const res = await fetch('/api/borrow/'+id, { method:'POST', headers:{'Content-Type':'application/json','x-admin-key':adminKey}, body:JSON.stringify({ borrower })});
  const out = await res.json();
  if(!res.ok) return alert(out.error||'‡∏¢‡∏∑‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  await refresh();
}
async function ret(id){
  const adminKey = document.getElementById('adminKey').value;
  if(!adminKey) return alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô?')) return;
  const res = await fetch('/api/return/'+id, { method:'POST', headers:{'x-admin-key':adminKey} });
  const out = await res.json();
  if(!res.ok) return alert(out.error||'‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  await refresh();
}

function resetForm(){
  document.getElementById('bookId').value='';
  document.getElementById('title').value='';
  document.getElementById('author').value='';
  document.getElementById('category').value='';
  document.getElementById('description').value='';
}

function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

document.addEventListener('DOMContentLoaded', refresh);
</script>
</body>
</html>
